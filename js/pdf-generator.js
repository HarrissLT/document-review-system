// js/pdf-generator.js

// Hàm chính được gọi từ file-handler.js
window.generatePDFReport = async function() {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;

    // 1. Lấy dữ liệu từ LocalStorage
    const rawData = localStorage.getItem('lastReviewResult');
    const fileName = localStorage.getItem('lastFileName') || 'Tai_lieu_chua_dat_ten';
    const currentUser = "Admin User"; // Hoặc lấy từ profile
    
    if (!rawData) {
        alert("Không tìm thấy dữ liệu đánh giá!");
        return;
    }
    const data = JSON.parse(rawData);

    try {
        // 2. Tạo tài liệu PDF mới
        const pdfDoc = await PDFDocument.create();
        
        // Đăng ký fontkit để nhúng font
        pdfDoc.registerFontkit(fontkit);

        // 3. Tải Font tiếng Việt (Roboto) từ CDN
        // Lưu ý: Cần internet để tải font này lần đầu
        const fontUrl = 'https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxP.ttf';
        const fontBytes = await fetch(fontUrl).then((res) => res.arrayBuffer());
        const customFont = await pdfDoc.embedFont(fontBytes);

        // Tạo trang A4
        const page = pdfDoc.addPage([595.28, 841.89]); // A4 size
        const { width, height } = page.getSize();
        const margin = 50;

        // --- BẮT ĐẦU VẼ NỘI DUNG ---

        // 1. Header (Logo & Tên tổ chức)
        page.drawText('EduReview AI System', {
            x: margin,
            y: height - 50,
            size: 10,
            font: customFont,
            color: rgb(0.5, 0.5, 0.5),
        });

        page.drawText('BÁO CÁO KIỂM DUYỆT TÀI LIỆU', {
            x: margin,
            y: height - 80,
            size: 24,
            font: customFont,
            color: rgb(0.2, 0.2, 0.8), // Màu xanh đậm
        });

        // 2. Thông tin chung (Vẽ đường kẻ và text)
        page.drawLine({
            start: { x: margin, y: height - 100 },
            end: { x: width - margin, y: height - 100 },
            thickness: 1,
            color: rgb(0.8, 0.8, 0.8),
        });

        const infoY = height - 130;
        drawTextLine(page, customFont, `Tên tài liệu: ${fileName}`, margin, infoY, 12);
        drawTextLine(page, customFont, `Người kiểm duyệt: ${currentUser}`, margin, infoY - 20, 12);
        drawTextLine(page, customFont, `Ngày thực hiện: ${new Date().toLocaleDateString('vi-VN')}`, margin, infoY - 40, 12);

        // 3. Bảng điểm số (Vẽ 2 hộp điểm)
        const scoreY = height - 220;
        
        // Hộp điểm Nội dung
        drawScoreBox(page, customFont, "ĐIỂM NỘI DUNG", data.score_content, margin, scoreY);
        
        // Hộp điểm Thiết kế
        drawScoreBox(page, customFont, "ĐIỂM THIẾT KẾ", data.score_design, margin + 150, scoreY);

        // 4. Con dấu (STAMP) - Vẽ đè lên
        const isApproved = data.status === 'approved';
        const stampColor = isApproved ? rgb(0.1, 0.7, 0.3) : rgb(0.9, 0.2, 0.2); // Xanh hoặc Đỏ
        const stampText = isApproved ? "ĐẠT YÊU CẦU" : "CẦN CHỈNH SỬA";
        
        page.save(); // Lưu trạng thái hiện tại
        page.translateContent(width - 150, height - 160);
        page.rotateDegrees(-15);
        
        // Vẽ khung dấu
        page.drawRectangle({
            x: 0, y: 0, width: 140, height: 50,
            borderColor: stampColor, borderWidth: 3,
            opacity: 0.8,
        });
        
        // Vẽ chữ trong dấu
        page.drawText(stampText, {
            x: 15, y: 15,
            size: 16, font: customFont, color: stampColor, opacity: 0.8
        });
        page.restore(); // Khôi phục trạng thái

        // 5. Chi tiết đánh giá
        let currentY = height - 320;

        // Tóm tắt
        drawSectionTitle(page, customFont, "1. TỔNG QUAN", margin, currentY);
        currentY -= 20;
        currentY = drawWrappedText(page, customFont, data.summary, margin, currentY, width - 2 * margin);

        // Điểm mạnh
        currentY -= 30;
        drawSectionTitle(page, customFont, "2. ĐIỂM MẠNH", margin, currentY);
        currentY -= 20;
        data.strengths.forEach(point => {
            currentY = drawWrappedText(page, customFont, `• ${point}`, margin + 10, currentY, width - 2 * margin - 10);
        });

        // Điểm yếu
        currentY -= 30;
        drawSectionTitle(page, customFont, "3. ĐIỂM CẦN CẢI THIỆN", margin, currentY);
        currentY -= 20;
        data.weaknesses.forEach(point => {
            currentY = drawWrappedText(page, customFont, `• ${point}`, margin + 10, currentY, width - 2 * margin - 10);
        });

        // Footer
        page.drawText('Generated by EduReview AI - Powered by Claude 3.5 Sonnet', {
            x: margin, y: 30, size: 8, font: customFont, color: rgb(0.6, 0.6, 0.6)
        });

        // 6. Xuất file
        const pdfBytes = await pdfDoc.save();
        downloadBlob(pdfBytes, `Bao_cao_${Date.now()}.pdf`, 'application/pdf');

        // 7. Lưu vào lịch sử (Gọi hàm từ history-manager)
        if(window.saveToHistory) {
            window.saveToHistory(fileName, data);
        }

    } catch (error) {
        console.error(error);
        alert("Lỗi tạo PDF: " + error.message);
    }
};

// --- CÁC HÀM HỖ TRỢ VẼ ---

function drawTextLine(page, font, text, x, y, size) {
    page.drawText(text, { x, y, size, font, color: PDFLib.rgb(0, 0, 0) });
}

function drawScoreBox(page, font, title, score, x, y) {
    const { rgb } = PDFLib;
    // Vẽ nền
    page.drawRectangle({
        x: x, y: y, width: 120, height: 80,
        color: rgb(0.95, 0.95, 0.95),
        borderColor: rgb(0.8, 0.8, 0.8), borderWidth: 1
    });
    // Vẽ điểm số
    page.drawText(score.toString(), {
        x: x + 40, y: y + 35,
        size: 30, font: font, color: rgb(0.2, 0.2, 0.8)
    });
    // Vẽ tiêu đề
    page.drawText(title, {
        x: x + 15, y: y + 10,
        size: 10, font: font, color: rgb(0.5, 0.5, 0.5)
    });
}

function drawSectionTitle(page, font, text, x, y) {
    page.drawText(text, {
        x, y, size: 14, font, color: PDFLib.rgb(0, 0, 0)
    });
}

// Hàm xuống dòng tự động cho văn bản dài
function drawWrappedText(page, font, text, x, y, maxWidth) {
    const fontSize = 11;
    const lineHeight = 16;
    
    // Tách từ
    const words = text.split(' ');
    let line = '';
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const width = font.widthOfTextAtSize(testLine, fontSize);
        
        if (width > maxWidth && n > 0) {
            page.drawText(line, { x, y, size: fontSize, font, color: PDFLib.rgb(0.2, 0.2, 0.2) });
            line = words[n] + ' ';
            y -= lineHeight;
        } else {
            line = testLine;
        }
    }
    page.drawText(line, { x, y, size: fontSize, font, color: PDFLib.rgb(0.2, 0.2, 0.2) });
    return y - lineHeight - 5; // Trả về vị trí Y tiếp theo
}

function downloadBlob(data, fileName, mimeType) {
    const blob = new Blob([data], { type: mimeType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }, 100);
}